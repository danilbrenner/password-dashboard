models:
  - name: stg_in_master_passwords
    description: "Staging table for master passwords hashes with parsed export timestamp"
    columns:
      - name: hash
        tests:
          - not_null
      - name: export_ts
        tests:
          - not_null

unit_tests:
  - name: test_stg_in_master_passwords_export_ts_parsing
    model: stg_in_master_passwords

    given:
      - input: ref('raw_master_passwords')
        rows:
          - {
            hash: "abc123",
            filename: "azure://password-dashboard/20251012154536/mp.csv"
          }
          - {
            hash: "def456",
            filename: "azure://password-dashboard/20251101120000/mp.csv"
          }

    expect:
      rows:
        - {
          hash: "abc123",
          export_ts: "2025-10-12 15:45:36"
        }
        - {
          hash: "def456",
          export_ts: "2025-11-01 12:00:00"
        }

    overrides:
      macros:
        is_incremental: false

  - name: test_stg_in_master_passwords_hash_not_null
    model: stg_in_master_passwords
    description: "Test that null hash values are filtered out"

    given:
      - input: ref('raw_master_passwords')
        rows:
          - {
            hash: "valid_hash_123",
            filename: "azure://password-dashboard/20251012154536/mp.csv"
          }
          - {
            hash: null,
            filename: "azure://password-dashboard/20251012154536/mp.csv"
          }

    expect:
      rows:
        - {
          hash: "valid_hash_123",
          export_ts: "2025-10-12 15:45:36"
        }

    overrides:
      macros:
        is_incremental: false

  - name: test_stg_in_master_passwords_hash_not_empty
    model: stg_in_master_passwords
    description: "Test that empty string hash values are filtered out"

    given:
      - input: ref('raw_master_passwords')
        rows:
          - {
            hash: "valid_hash_456",
            filename: "azure://password-dashboard/20251012154536/mp.csv"
          }
          - {
            hash: "",
            filename: "azure://password-dashboard/20251012154536/mp.csv"
          }
          - {
            hash: "   ",
            filename: "azure://password-dashboard/20251012154536/mp.csv"
          }

    expect:
      rows:
        - {
          hash: "valid_hash_456",
          export_ts: "2025-10-12 15:45:36"
        }

    overrides:
      macros:
        is_incremental: false

